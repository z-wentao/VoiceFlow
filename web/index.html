<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceFlow</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* 标记字幕区域为英文内容，提示翻译插件 */
        [id^="subtitle-"] {
            direction: ltr;
        }
        [id^="subtitle-"] span {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        }
    </style>
</head>
<body>
    <h1>VoiceFlow</h1>
    <p>音频转文字平台</p>
    <hr>

    <!-- 上传区域 -->
    <h2>上传文件</h2>
    <form id="uploadForm"
          hx-post="/api/upload"
          hx-target="#tasksList"
          hx-swap="afterbegin"
          hx-on::after-request="this.reset()"
          hx-encoding="multipart/form-data">
        <input type="file"
               id="fileInput"
               name="audio"
               accept="video/*,audio/*,.mp4,.webm,.mov,.avi,.mkv,.mp3,.wav,.m4a,.flac,.aac"
               multiple
               onchange="handleMultipleFiles(event)">
        <p>支持 MP4, WEBM, MOV, MP3, WAV, M4A, FLAC, AAC 等格式</p>
    </form>
    <hr>

    <!-- 任务列表 -->
    <h2>任务列表</h2>
    <p>任务数: <span id="tasksCount"
                     hx-get="/api/jobs/count"
                     hx-trigger="load, taskUpdated from:body">0</span></p>

    <div style="margin-bottom: 10px;">
        <button hx-get="/api/jobs"
                hx-target="#tasksList"
                hx-swap="innerHTML"
                style="margin-right: 10px; padding: 8px 16px; cursor: pointer;">
            当前任务
        </button>
        <button hx-get="/api/jobs/history"
                hx-target="#tasksList"
                hx-swap="innerHTML"
                style="padding: 8px 16px; cursor: pointer;">
            所有历史记录
        </button>
    </div>

    <div id="tasksList"
         hx-get="/api/jobs"
         hx-trigger="load, every 2s[document.querySelector('.task-card[data-status=processing], .task-card[data-status=pending]')], taskUpdated from:body"
         hx-swap="innerHTML swap:0.2s">
        <p>暂无任务</p>
    </div>
    <script>
        function handleMultipleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            files.forEach(file => {
                const formData = new FormData();
                formData.append('audio', file);

                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(html => {
                    const tasksList = document.getElementById('tasksList');
                    if (tasksList.querySelector('p')) {
                        tasksList.innerHTML = '';
                    }
                    tasksList.insertAdjacentHTML('afterbegin', html);
                    htmx.trigger(document.body, 'taskUpdated');
                });
            });

            event.target.value = '';
        }

        function togglePlayer(jobId) {
            const player = document.getElementById('player-' + jobId);
            if (player) {
                player.hidden = !player.hidden;
            }
        }

        function showMaimemoForm(jobId) {
            document.getElementById('maimemo-form-' + jobId).hidden = false;

            // 自动填充保存的值
            const savedToken = localStorage.getItem('maimemo_token') || '';
            const savedNotepadId = localStorage.getItem('maimemo_notepad_id') || '';

            const tokenInput = document.getElementById('token-' + jobId);
            const notepadInput = document.getElementById('notepad-' + jobId);

            if (tokenInput && tokenInput.value === '') tokenInput.value = savedToken;
            if (notepadInput && notepadInput.value === '') notepadInput.value = savedNotepadId;
        }

        function hideMaimemoForm(jobId) {
            document.getElementById('maimemo-form-' + jobId).hidden = true;
        }

        function selectNotepad(jobId, notepadId) {
            document.getElementById('notepad-' + jobId).value = notepadId;
            document.getElementById('notepad-list-' + jobId).hidden = true;
            // 保存选择的云词本 ID
            saveNotepadId(notepadId);
        }

        function saveToken(token) {
            if (token) localStorage.setItem('maimemo_token', token);
        }

        function saveNotepadId(notepadId) {
            if (notepadId) localStorage.setItem('maimemo_notepad_id', notepadId);
        }

        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('maimemo_token') || '';
            const savedNotepadId = localStorage.getItem('maimemo_notepad_id') || '';

            document.querySelectorAll('[id^="token-"]').forEach(el => {
                if (el.value === '' && savedToken) el.value = savedToken;
            });
            document.querySelectorAll('[id^="notepad-"]').forEach(el => {
                if (el.value === '' && savedNotepadId) el.value = savedNotepadId;
            });
        });
    </script>
</body>
</html>
