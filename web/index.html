<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceFlow - 音频转文字平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .task-toggle.expanded {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center text-white mb-8">
            <h1 class="text-5xl md:text-6xl font-bold mb-3">🎙️ VoiceFlow</h1>
            <p class="text-xl opacity-90">音频转文字平台 - 支持多文件并发处理</p>
        </div>

        <!-- Upload Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <div
                id="uploadBox"
                onclick="document.getElementById('fileInput').click()"
                class="border-3 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50"
            >
                <p class="text-6xl mb-4">📁</p>
                <p class="text-lg font-semibold text-gray-800 mb-2">点击或拖拽上传音频/视频文件</p>
                <p class="text-sm text-gray-500">支持 MP3, MP4, WAV, M4A, FLAC, AAC 等格式 · 最大 300MB</p>
                <p class="text-xs text-gray-400 mt-2">💡 支持多文件同时上传</p>
                <input type="file" id="fileInput" class="hidden" accept="audio/*,video/mp4,video/webm" multiple onchange="handleFileSelect(event)">
            </div>
        </div>

        <!-- Tasks Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">📋 任务列表</h2>
                <span id="tasksCount" class="bg-indigo-500 text-white px-4 py-1 rounded-full text-sm font-semibold">0 个任务</span>
            </div>

            <div id="tasksList" class="space-y-4">
                <div class="text-center py-16 text-gray-400">
                    <p class="text-5xl mb-3">📭</p>
                    <p class="text-lg">暂无任务，上传文件开始吧！</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 全局状态管理 ==========
        const state = {
            jobs: {},
            expandedJobs: {},
            pollInterval: null,
            maimemoConfig: {
                token: localStorage.getItem('maimemo_token') || '',
                notepadId: localStorage.getItem('maimemo_notepad_id') || ''
            }
        };

        // ========== localStorage 管理 ==========
        function saveMaimemoConfig(token, notepadId) {
            if (token) {
                localStorage.setItem('maimemo_token', token);
                state.maimemoConfig.token = token;
            }
            if (notepadId) {
                localStorage.setItem('maimemo_notepad_id', notepadId);
                state.maimemoConfig.notepadId = notepadId;
            }
        }

        // ========== 拖拽上传 ==========
        const uploadBox = document.getElementById('uploadBox');

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('border-indigo-500', 'bg-indigo-100');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('border-indigo-500', 'bg-indigo-100');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('border-indigo-500', 'bg-indigo-100');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => uploadFile(file));
        });

        // ========== 文件上传 ==========
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            files.forEach(file => uploadFile(file));
            document.getElementById('fileInput').value = '';
        }

        async function uploadFile(file) {
            console.log('上传文件:', file.name);
            const formData = new FormData();
            formData.append('audio', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const job = {
                        job_id: data.job_id,
                        filename: data.filename,
                        status: data.status,
                        progress: 0,
                        result: '',
                        error: '',
                        created_at: new Date().toISOString()
                    };
                    addJob(job);
                    startPolling();
                } else {
                    alert(`上传失败: ${data.error}`);
                }
            } catch (error) {
                console.error('上传错误:', error);
                alert(`上传失败: ${error.message}`);
            }
        }

        // ========== 任务管理 ==========
        function addJob(job) {
            state.jobs[job.job_id] = job;
            state.expandedJobs[job.job_id] = false;
            renderTasks();
        }

        function updateJob(jobId, updates) {
            if (!state.jobs[jobId]) return;
            const job = state.jobs[jobId];
            let changed = false;

            for (const key in updates) {
                if (JSON.stringify(job[key]) !== JSON.stringify(updates[key])) {
                    changed = true;
                    break;
                }
            }

            if (!changed) return;
            Object.assign(job, updates);
            updateTaskCard(jobId);
        }

        function toggleJobExpanded(jobId) {
            state.expandedJobs[jobId] = !state.expandedJobs[jobId];
            const taskCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (taskCard) {
                const details = taskCard.querySelector('.task-details');
                const toggle = taskCard.querySelector('.task-toggle');
                if (state.expandedJobs[jobId]) {
                    details.classList.remove('hidden');
                    toggle.classList.add('expanded');
                } else {
                    details.classList.add('hidden');
                    toggle.classList.remove('expanded');
                }
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('确定要删除这个任务吗？')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    // 删除成功，从本地状态中移除
                    delete state.jobs[jobId];
                    delete state.expandedJobs[jobId];
                    renderTasks();
                    console.log('任务已删除:', jobId);
                } else {
                    alert(`删除失败: ${data.error}`);
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                alert(`删除失败: ${error.message}`);
            }
        }

        function toggleAudioPlayer(jobId) {
            const player = document.getElementById(`audioPlayer-${jobId}`);
            if (player) {
                player.classList.toggle('hidden');
            }
        }

        function downloadResult(jobId) {
            const job = state.jobs[jobId];
            if (!job || !job.result) return;

            const blob = new Blob([job.result], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${job.filename}_转录.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== 渲染 ==========
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const tasksCount = document.getElementById('tasksCount');
            const jobsArray = Object.values(state.jobs);
            const jobCount = jobsArray.length;

            tasksCount.textContent = `${jobCount} 个任务`;

            if (jobCount === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-16 text-gray-400">
                        <p class="text-5xl mb-3">📭</p>
                        <p class="text-lg">暂无任务，上传文件开始吧！</p>
                    </div>
                `;
                return;
            }

            jobsArray.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            tasksList.innerHTML = jobsArray.map(job => renderTaskCard(job)).join('');
        }

        function updateTaskCard(jobId) {
            const job = state.jobs[jobId];
            if (!job) return;

            const taskCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (!taskCard) {
                renderTasks();
                return;
            }

            const isExpanded = state.expandedJobs[jobId];
            const tokenInput = taskCard.querySelector(`#token-${jobId}`);
            const notepadInput = taskCard.querySelector(`#notepadId-${jobId}`);
            const currentToken = tokenInput ? tokenInput.value : '';
            const currentNotepadId = notepadInput ? notepadInput.value : '';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = renderTaskCard(job);
            const newTaskCard = tempDiv.firstElementChild;

            if (isExpanded) {
                const details = newTaskCard.querySelector('.task-details');
                const toggle = newTaskCard.querySelector('.task-toggle');
                if (details) details.classList.remove('hidden');
                if (toggle) toggle.classList.add('expanded');
            }

            taskCard.replaceWith(newTaskCard);

            if (currentToken || currentNotepadId) {
                const newTokenInput = newTaskCard.querySelector(`#token-${jobId}`);
                const newNotepadInput = newTaskCard.querySelector(`#notepadId-${jobId}`);
                if (newTokenInput && currentToken) newTokenInput.value = currentToken;
                if (newNotepadInput && currentNotepadId) newNotepadInput.value = currentNotepadId;
            }
        }

        function renderTaskCard(job) {
            const isExpanded = state.expandedJobs[job.job_id];
            const statusConfig = {
                'pending': { text: '等待处理', class: 'bg-yellow-400 text-black' },
                'processing': { text: '处理中', class: 'bg-blue-500 text-white' },
                'completed': { text: '已完成', class: 'bg-green-500 text-white' },
                'failed': { text: '失败', class: 'bg-red-500 text-white' }
            };
            const status = statusConfig[job.status] || { text: '未知', class: 'bg-gray-500 text-white' };

            return `
                <div class="bg-gray-50 rounded-xl p-5 border-2 border-transparent hover:border-indigo-500 hover:shadow-lg transition-all duration-300" data-job-id="${job.job_id}">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleJobExpanded('${job.job_id}')">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-base font-semibold text-gray-800">${escapeHtml(job.filename)}</span>
                                ${job.status === 'processing' ? '<span class="spinner"></span>' : ''}
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-600">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${status.class}">${status.text}</span>
                                ${job.progress > 0 ? `<span>进度: ${job.progress}%</span>` : ''}
                                <span>${formatTime(job.created_at)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                            <button onclick="toggleAudioPlayer('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">🎵 播放</button>
                            ${job.status === 'completed' ? `
                                <button onclick="downloadResult('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">📥 下载</button>
                                <button onclick="extractVocabulary('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">📚 提取单词</button>
                            ` : ''}
                            <button onclick="deleteJob('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-red-500 hover:text-white hover:border-red-500 transition-colors">🗑️ 删除</button>
                            <button class="task-toggle text-indigo-500 text-2xl w-8 h-8 flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'expanded' : ''}">▼</button>
                        </div>
                    </div>

                    <div class="task-details mt-5 pt-5 border-t border-gray-200 ${isExpanded ? '' : 'hidden'}">
                        <!-- 音频播放器 -->
                        <div id="audioPlayer-${job.job_id}" class="hidden mb-5">
                            <h4 class="font-semibold text-gray-800 mb-2">🎵 音频播放</h4>
                            <audio controls class="w-full" src="/${job.file_path}">
                                您的浏览器不支持音频播放
                            </audio>
                        </div>

                        ${(job.status === 'processing' || job.status === 'completed') && job.progress > 0 ? `
                            <div class="mb-5">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>转换进度</span>
                                    <span>${job.progress}%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width: ${job.progress}%"></div>
                                </div>
                            </div>
                        ` : ''}

                        ${job.status === 'completed' && job.result ? `
                            <div class="mb-5">
                                <h4 class="font-semibold text-gray-800 mb-3">转录结果</h4>
                                <div class="bg-white border border-gray-200 rounded-lg p-4 max-h-80 overflow-y-auto">
                                    <div class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700">${escapeHtml(job.result)}</div>
                                </div>
                            </div>
                        ` : ''}

                        ${job.status === 'failed' && job.error ? `
                            <div class="bg-red-50 text-red-800 p-3 rounded-lg text-sm">
                                ❌ 错误: ${escapeHtml(job.error)}
                            </div>
                        ` : ''}

                        ${job.status === 'completed' && job.vocab_detail && job.vocab_detail.length > 0 ? `
                            <div class="mt-5 pt-5 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-gray-800">📚 提取的单词 (${job.vocab_detail.length})</h4>
                                    <button onclick="showMaimemoForm('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">🔄 同步到墨墨</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                                    ${job.vocab_detail.map(word => `
                                        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-indigo-500 hover:shadow-md transition-all">
                                            <div class="font-semibold text-gray-800 mb-1">${escapeHtml(word.word)}</div>
                                            <div class="text-sm text-gray-600 mb-1">${escapeHtml(word.definition)}</div>
                                            ${word.example ? `<div class="text-xs text-gray-400 italic">${escapeHtml(word.example)}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>

                                <div id="maimemoForm-${job.job_id}" class="hidden mt-4 bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">同步到墨墨背单词</h4>
                                    <div class="mb-3">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">
                                            墨墨 API Token
                                            <a href="#" onclick="alert('获取方式：打开墨墨 APP → 我的 → 更多设置 → 实验功能 → 开放 API'); return false;" class="text-indigo-500 text-xs ml-1">[如何获取?]</a>
                                        </label>
                                        <input type="text" id="token-${job.job_id}" placeholder="输入你的 Token" value="${state.maimemoConfig.token}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                    </div>
                                    <div class="mb-3">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">
                                            云词本 ID
                                            <button type="button" onclick="loadNotepads('${job.job_id}')" class="text-indigo-500 text-xs ml-1 underline">🔍 查询我的云词本</button>
                                        </label>
                                        <input type="text" id="notepadId-${job.job_id}" placeholder="输入云词本 ID 或点击查询选择" value="${state.maimemoConfig.notepadId}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                        <div id="notepadList-${job.job_id}" class="hidden mt-2 bg-white border border-gray-300 rounded-lg max-h-48 overflow-y-auto"></div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="syncToMaimemo('${job.job_id}')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-sm">确认同步</button>
                                        <button onclick="hideMaimemoForm('${job.job_id}')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">取消</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========== 轮询 ==========
        function startPolling() {
            if (state.pollInterval) return;
            pollAllJobs();
            state.pollInterval = setInterval(pollAllJobs, 3000);
        }

        function stopPolling() {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
                state.pollInterval = null;
            }
        }

        async function pollAllJobs() {
            const jobsArray = Object.values(state.jobs);
            const activeJobs = jobsArray.filter(job => job.status === 'pending' || job.status === 'processing');

            if (activeJobs.length === 0) {
                stopPolling();
                return;
            }

            await Promise.all(activeJobs.map(job => pollJobStatus(job.job_id)));
        }

        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                if (response.ok) {
                    updateJob(jobId, job);
                }
            } catch (error) {
                console.error('轮询错误:', error);
            }
        }

        // ========== 工具函数 ==========
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} 分钟前`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} 小时前`;
            return date.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== 单词提取 ==========
        async function extractVocabulary(jobId) {
            if (!confirm('确定要提取这个任务中的英文单词吗？\n\n这将使用 AI 分析文本内容，可能需要几秒钟。')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}/extract-vocabulary`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    alert(`✅ 成功提取 ${data.count} 个单词！`);
                    updateJob(jobId, {
                        vocabulary: data.vocabulary,
                        vocab_detail: data.vocab_detail
                    });
                    if (!state.expandedJobs[jobId]) {
                        toggleJobExpanded(jobId);
                    }
                } else {
                    alert(`❌ 提取失败: ${data.error}`);
                }
            } catch (error) {
                alert(`❌ 提取失败: ${error.message}`);
            }
        }

        // ========== 墨墨同步 ==========
        function showMaimemoForm(jobId) {
            const form = document.getElementById(`maimemoForm-${jobId}`);
            if (form) {
                form.classList.remove('hidden');
                const tokenInput = document.getElementById(`token-${jobId}`);
                const notepadInput = document.getElementById(`notepadId-${jobId}`);
                if (tokenInput && !tokenInput.value) tokenInput.value = state.maimemoConfig.token;
                if (notepadInput && !notepadInput.value) notepadInput.value = state.maimemoConfig.notepadId;
            }
        }

        function hideMaimemoForm(jobId) {
            const form = document.getElementById(`maimemoForm-${jobId}`);
            if (form) {
                form.classList.add('hidden');
                const notepadList = document.getElementById(`notepadList-${jobId}`);
                if (notepadList) notepadList.classList.add('hidden');
            }
        }

        async function loadNotepads(jobId) {
            const token = document.getElementById(`token-${jobId}`).value.trim();
            if (!token) {
                alert('请先输入墨墨 API Token');
                return;
            }

            const notepadList = document.getElementById(`notepadList-${jobId}`);
            notepadList.innerHTML = '<div class="p-3 text-center"><span class="spinner"></span> 查询中...</div>';
            notepadList.classList.remove('hidden');

            try {
                const response = await fetch('/api/maimemo/list-notepads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const data = await response.json();

                if (response.ok && data.notepads && data.notepads.length > 0) {
                    notepadList.innerHTML = data.notepads.map(notepad => `
                        <div onclick="selectNotepad('${jobId}', '${notepad.id}', '${escapeHtml(notepad.title || '未命名词本')}')" class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="font-semibold text-gray-800">${escapeHtml(notepad.title || '未命名词本')}</div>
                            <div class="text-xs text-gray-500">${notepad.brief ? escapeHtml(notepad.brief) : 'ID: ' + notepad.id}</div>
                        </div>
                    `).join('');
                } else {
                    notepadList.innerHTML = `<div class="p-5 text-center text-gray-400"><p>📭 您还没有创建云词本</p><p class="text-xs mt-1">请在墨墨 APP 中创建云词本</p></div>`;
                }
            } catch (error) {
                notepadList.innerHTML = `<div class="p-4 text-center text-red-800">❌ 查询失败: ${error.message}</div>`;
            }
        }

        function selectNotepad(jobId, notepadId, notepadName) {
            const input = document.getElementById(`notepadId-${jobId}`);
            if (input) input.value = notepadId;

            const notepadList = document.getElementById(`notepadList-${jobId}`);
            if (notepadList) notepadList.classList.add('hidden');

            console.log(`已选择云词本: ${notepadName} (ID: ${notepadId})`);
        }

        async function syncToMaimemo(jobId) {
            const token = document.getElementById(`token-${jobId}`).value.trim();
            const notepadId = document.getElementById(`notepadId-${jobId}`).value.trim();

            if (!token) {
                alert('请输入墨墨 API Token');
                return;
            }
            if (!notepadId) {
                alert('请输入云词本 ID');
                return;
            }

            const job = state.jobs[jobId];
            if (!job || !job.vocabulary || job.vocabulary.length === 0) {
                alert('没有可同步的单词');
                return;
            }

            if (!confirm(`确定要将 ${job.vocabulary.length} 个单词同步到墨墨背单词吗？`)) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}/sync-to-maimemo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, notepad_id: notepadId })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ ${data.message}\n\n已成功同步 ${data.count} 个单词到墨墨背单词！`);
                    saveMaimemoConfig(token, notepadId);
                    hideMaimemoForm(jobId);
                } else {
                    alert(`❌ 同步失败: ${data.error}`);
                }
            } catch (error) {
                alert(`❌ 同步失败: ${error.message}`);
            }
        }

        // ========== 初始化 ==========
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();

                if (data.jobs && data.jobs.length > 0) {
                    data.jobs.forEach(job => {
                        state.jobs[job.job_id] = job;
                        state.expandedJobs[job.job_id] = false;
                    });
                    renderTasks();
                    startPolling();
                }
            } catch (error) {
                console.error('加载任务列表失败:', error);
            }
        });

        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>
