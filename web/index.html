<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceFlow - éŸ³é¢‘è½¬æ–‡å­—å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .task-toggle.expanded {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center text-white mb-8">
            <h1 class="text-5xl md:text-6xl font-bold mb-3">ğŸ™ï¸ VoiceFlow</h1>
            <p class="text-xl opacity-90">éŸ³é¢‘è½¬æ–‡å­—å¹³å° - æ”¯æŒå¤šæ–‡ä»¶å¹¶å‘å¤„ç†</p>
        </div>

        <!-- Upload Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
            <div
                id="uploadBox"
                onclick="document.getElementById('fileInput').click()"
                class="border-3 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50"
            >
                <p class="text-6xl mb-4">ğŸ“</p>
                <p class="text-lg font-semibold text-gray-800 mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ éŸ³é¢‘/è§†é¢‘æ–‡ä»¶</p>
                <p class="text-sm text-gray-500">æ”¯æŒ MP3, MP4, WAV, M4A, FLAC, AAC ç­‰æ ¼å¼ Â· æœ€å¤§ 300MB</p>
                <p class="text-xs text-gray-400 mt-2">ğŸ’¡ æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶ä¸Šä¼ </p>
                <input type="file" id="fileInput" class="hidden" accept="audio/*,video/mp4,video/webm" multiple onchange="handleFileSelect(event)">
            </div>
        </div>

        <!-- Tasks Card -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</h2>
                <span id="tasksCount" class="bg-indigo-500 text-white px-4 py-1 rounded-full text-sm font-semibold">0 ä¸ªä»»åŠ¡</span>
            </div>

            <div id="tasksList" class="space-y-4">
                <div class="text-center py-16 text-gray-400">
                    <p class="text-5xl mb-3">ğŸ“­</p>
                    <p class="text-lg">æš‚æ— ä»»åŠ¡ï¼Œä¸Šä¼ æ–‡ä»¶å¼€å§‹å§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ç®¡ç† ==========
        const state = {
            jobs: {},
            expandedJobs: {},
            pollInterval: null,
            maimemoConfig: {
                token: localStorage.getItem('maimemo_token') || '',
                notepadId: localStorage.getItem('maimemo_notepad_id') || ''
            }
        };

        // ========== localStorage ç®¡ç† ==========
        function saveMaimemoConfig(token, notepadId) {
            if (token) {
                localStorage.setItem('maimemo_token', token);
                state.maimemoConfig.token = token;
            }
            if (notepadId) {
                localStorage.setItem('maimemo_notepad_id', notepadId);
                state.maimemoConfig.notepadId = notepadId;
            }
        }

        // ========== æ‹–æ‹½ä¸Šä¼  ==========
        const uploadBox = document.getElementById('uploadBox');

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('border-indigo-500', 'bg-indigo-100');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('border-indigo-500', 'bg-indigo-100');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('border-indigo-500', 'bg-indigo-100');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => uploadFile(file));
        });

        // ========== æ–‡ä»¶ä¸Šä¼  ==========
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            files.forEach(file => uploadFile(file));
            document.getElementById('fileInput').value = '';
        }

        async function uploadFile(file) {
            console.log('ä¸Šä¼ æ–‡ä»¶:', file.name);
            const formData = new FormData();
            formData.append('audio', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const job = {
                        job_id: data.job_id,
                        filename: data.filename,
                        status: data.status,
                        progress: 0,
                        result: '',
                        error: '',
                        created_at: new Date().toISOString()
                    };
                    addJob(job);
                    startPolling();
                } else {
                    alert(`ä¸Šä¼ å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }

        // ========== ä»»åŠ¡ç®¡ç† ==========
        function addJob(job) {
            state.jobs[job.job_id] = job;
            state.expandedJobs[job.job_id] = false;
            renderTasks();
        }

        function updateJob(jobId, updates) {
            if (!state.jobs[jobId]) return;
            const job = state.jobs[jobId];
            let changed = false;

            for (const key in updates) {
                if (JSON.stringify(job[key]) !== JSON.stringify(updates[key])) {
                    changed = true;
                    break;
                }
            }

            if (!changed) return;
            Object.assign(job, updates);
            updateTaskCard(jobId);
        }

        function toggleJobExpanded(jobId) {
            state.expandedJobs[jobId] = !state.expandedJobs[jobId];
            const taskCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (taskCard) {
                const details = taskCard.querySelector('.task-details');
                const toggle = taskCard.querySelector('.task-toggle');
                if (state.expandedJobs[jobId]) {
                    details.classList.remove('hidden');
                    toggle.classList.add('expanded');
                } else {
                    details.classList.add('hidden');
                    toggle.classList.remove('expanded');
                }
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    // åˆ é™¤æˆåŠŸï¼Œä»æœ¬åœ°çŠ¶æ€ä¸­ç§»é™¤
                    delete state.jobs[jobId];
                    delete state.expandedJobs[jobId];
                    renderTasks();
                    console.log('ä»»åŠ¡å·²åˆ é™¤:', jobId);
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        function toggleAudioPlayer(jobId) {
            const player = document.getElementById(`audioPlayer-${jobId}`);
            if (player) {
                player.classList.toggle('hidden');
            }
        }

        function downloadResult(jobId) {
            const job = state.jobs[jobId];
            if (!job || !job.result) return;

            const blob = new Blob([job.result], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${job.filename}_è½¬å½•.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== æ¸²æŸ“ ==========
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const tasksCount = document.getElementById('tasksCount');
            const jobsArray = Object.values(state.jobs);
            const jobCount = jobsArray.length;

            tasksCount.textContent = `${jobCount} ä¸ªä»»åŠ¡`;

            if (jobCount === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-16 text-gray-400">
                        <p class="text-5xl mb-3">ğŸ“­</p>
                        <p class="text-lg">æš‚æ— ä»»åŠ¡ï¼Œä¸Šä¼ æ–‡ä»¶å¼€å§‹å§ï¼</p>
                    </div>
                `;
                return;
            }

            jobsArray.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            tasksList.innerHTML = jobsArray.map(job => renderTaskCard(job)).join('');
        }

        function updateTaskCard(jobId) {
            const job = state.jobs[jobId];
            if (!job) return;

            const taskCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (!taskCard) {
                renderTasks();
                return;
            }

            const isExpanded = state.expandedJobs[jobId];
            const tokenInput = taskCard.querySelector(`#token-${jobId}`);
            const notepadInput = taskCard.querySelector(`#notepadId-${jobId}`);
            const currentToken = tokenInput ? tokenInput.value : '';
            const currentNotepadId = notepadInput ? notepadInput.value : '';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = renderTaskCard(job);
            const newTaskCard = tempDiv.firstElementChild;

            if (isExpanded) {
                const details = newTaskCard.querySelector('.task-details');
                const toggle = newTaskCard.querySelector('.task-toggle');
                if (details) details.classList.remove('hidden');
                if (toggle) toggle.classList.add('expanded');
            }

            taskCard.replaceWith(newTaskCard);

            if (currentToken || currentNotepadId) {
                const newTokenInput = newTaskCard.querySelector(`#token-${jobId}`);
                const newNotepadInput = newTaskCard.querySelector(`#notepadId-${jobId}`);
                if (newTokenInput && currentToken) newTokenInput.value = currentToken;
                if (newNotepadInput && currentNotepadId) newNotepadInput.value = currentNotepadId;
            }
        }

        function renderTaskCard(job) {
            const isExpanded = state.expandedJobs[job.job_id];
            const statusConfig = {
                'pending': { text: 'ç­‰å¾…å¤„ç†', class: 'bg-yellow-400 text-black' },
                'processing': { text: 'å¤„ç†ä¸­', class: 'bg-blue-500 text-white' },
                'completed': { text: 'å·²å®Œæˆ', class: 'bg-green-500 text-white' },
                'failed': { text: 'å¤±è´¥', class: 'bg-red-500 text-white' }
            };
            const status = statusConfig[job.status] || { text: 'æœªçŸ¥', class: 'bg-gray-500 text-white' };

            return `
                <div class="bg-gray-50 rounded-xl p-5 border-2 border-transparent hover:border-indigo-500 hover:shadow-lg transition-all duration-300" data-job-id="${job.job_id}">
                    <div class="flex justify-between items-center cursor-pointer" onclick="toggleJobExpanded('${job.job_id}')">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-base font-semibold text-gray-800">${escapeHtml(job.filename)}</span>
                                ${job.status === 'processing' ? '<span class="spinner"></span>' : ''}
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-600">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase ${status.class}">${status.text}</span>
                                ${job.progress > 0 ? `<span>è¿›åº¦: ${job.progress}%</span>` : ''}
                                <span>${formatTime(job.created_at)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                            <button onclick="toggleAudioPlayer('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">ğŸµ æ’­æ”¾</button>
                            ${job.status === 'completed' ? `
                                <button onclick="downloadResult('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">ğŸ“¥ ä¸‹è½½</button>
                                <button onclick="extractVocabulary('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">ğŸ“š æå–å•è¯</button>
                            ` : ''}
                            <button onclick="deleteJob('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-red-500 hover:text-white hover:border-red-500 transition-colors">ğŸ—‘ï¸ åˆ é™¤</button>
                            <button class="task-toggle text-indigo-500 text-2xl w-8 h-8 flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'expanded' : ''}">â–¼</button>
                        </div>
                    </div>

                    <div class="task-details mt-5 pt-5 border-t border-gray-200 ${isExpanded ? '' : 'hidden'}">
                        <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                        <div id="audioPlayer-${job.job_id}" class="hidden mb-5">
                            <h4 class="font-semibold text-gray-800 mb-2">ğŸµ éŸ³é¢‘æ’­æ”¾</h4>
                            <audio controls class="w-full" src="/${job.file_path}">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                        </div>

                        ${(job.status === 'processing' || job.status === 'completed') && job.progress > 0 ? `
                            <div class="mb-5">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>è½¬æ¢è¿›åº¦</span>
                                    <span>${job.progress}%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width: ${job.progress}%"></div>
                                </div>
                            </div>
                        ` : ''}

                        ${job.status === 'completed' && job.result ? `
                            <div class="mb-5">
                                <h4 class="font-semibold text-gray-800 mb-3">è½¬å½•ç»“æœ</h4>
                                <div class="bg-white border border-gray-200 rounded-lg p-4 max-h-80 overflow-y-auto">
                                    <div class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700">${escapeHtml(job.result)}</div>
                                </div>
                            </div>
                        ` : ''}

                        ${job.status === 'failed' && job.error ? `
                            <div class="bg-red-50 text-red-800 p-3 rounded-lg text-sm">
                                âŒ é”™è¯¯: ${escapeHtml(job.error)}
                            </div>
                        ` : ''}

                        ${job.status === 'completed' && job.vocab_detail && job.vocab_detail.length > 0 ? `
                            <div class="mt-5 pt-5 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-gray-800">ğŸ“š æå–çš„å•è¯ (${job.vocab_detail.length})</h4>
                                    <button onclick="showMaimemoForm('${job.job_id}')" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-indigo-500 hover:text-white hover:border-indigo-500 transition-colors">ğŸ”„ åŒæ­¥åˆ°å¢¨å¢¨</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                                    ${job.vocab_detail.map(word => `
                                        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-indigo-500 hover:shadow-md transition-all">
                                            <div class="font-semibold text-gray-800 mb-1">${escapeHtml(word.word)}</div>
                                            <div class="text-sm text-gray-600 mb-1">${escapeHtml(word.definition)}</div>
                                            ${word.example ? `<div class="text-xs text-gray-400 italic">${escapeHtml(word.example)}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>

                                <div id="maimemoForm-${job.job_id}" class="hidden mt-4 bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">åŒæ­¥åˆ°å¢¨å¢¨èƒŒå•è¯</h4>
                                    <div class="mb-3">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">
                                            å¢¨å¢¨ API Token
                                            <a href="#" onclick="alert('è·å–æ–¹å¼ï¼šæ‰“å¼€å¢¨å¢¨ APP â†’ æˆ‘çš„ â†’ æ›´å¤šè®¾ç½® â†’ å®éªŒåŠŸèƒ½ â†’ å¼€æ”¾ API'); return false;" class="text-indigo-500 text-xs ml-1">[å¦‚ä½•è·å–?]</a>
                                        </label>
                                        <input type="text" id="token-${job.job_id}" placeholder="è¾“å…¥ä½ çš„ Token" value="${state.maimemoConfig.token}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                    </div>
                                    <div class="mb-3">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">
                                            äº‘è¯æœ¬ ID
                                            <button type="button" onclick="loadNotepads('${job.job_id}')" class="text-indigo-500 text-xs ml-1 underline">ğŸ” æŸ¥è¯¢æˆ‘çš„äº‘è¯æœ¬</button>
                                        </label>
                                        <input type="text" id="notepadId-${job.job_id}" placeholder="è¾“å…¥äº‘è¯æœ¬ ID æˆ–ç‚¹å‡»æŸ¥è¯¢é€‰æ‹©" value="${state.maimemoConfig.notepadId}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                                        <div id="notepadList-${job.job_id}" class="hidden mt-2 bg-white border border-gray-300 rounded-lg max-h-48 overflow-y-auto"></div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="syncToMaimemo('${job.job_id}')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-sm">ç¡®è®¤åŒæ­¥</button>
                                        <button onclick="hideMaimemoForm('${job.job_id}')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========== è½®è¯¢ ==========
        function startPolling() {
            if (state.pollInterval) return;
            pollAllJobs();
            state.pollInterval = setInterval(pollAllJobs, 3000);
        }

        function stopPolling() {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
                state.pollInterval = null;
            }
        }

        async function pollAllJobs() {
            const jobsArray = Object.values(state.jobs);
            const activeJobs = jobsArray.filter(job => job.status === 'pending' || job.status === 'processing');

            if (activeJobs.length === 0) {
                stopPolling();
                return;
            }

            await Promise.all(activeJobs.map(job => pollJobStatus(job.job_id)));
        }

        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                if (response.ok) {
                    updateJob(jobId, job);
                }
            } catch (error) {
                console.error('è½®è¯¢é”™è¯¯:', error);
            }
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} åˆ†é’Ÿå‰`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} å°æ—¶å‰`;
            return date.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== å•è¯æå– ==========
        async function extractVocabulary(jobId) {
            if (!confirm('ç¡®å®šè¦æå–è¿™ä¸ªä»»åŠ¡ä¸­çš„è‹±æ–‡å•è¯å—ï¼Ÿ\n\nè¿™å°†ä½¿ç”¨ AI åˆ†ææ–‡æœ¬å†…å®¹ï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}/extract-vocabulary`, { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… æˆåŠŸæå– ${data.count} ä¸ªå•è¯ï¼`);
                    updateJob(jobId, {
                        vocabulary: data.vocabulary,
                        vocab_detail: data.vocab_detail
                    });
                    if (!state.expandedJobs[jobId]) {
                        toggleJobExpanded(jobId);
                    }
                } else {
                    alert(`âŒ æå–å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ æå–å¤±è´¥: ${error.message}`);
            }
        }

        // ========== å¢¨å¢¨åŒæ­¥ ==========
        function showMaimemoForm(jobId) {
            const form = document.getElementById(`maimemoForm-${jobId}`);
            if (form) {
                form.classList.remove('hidden');
                const tokenInput = document.getElementById(`token-${jobId}`);
                const notepadInput = document.getElementById(`notepadId-${jobId}`);
                if (tokenInput && !tokenInput.value) tokenInput.value = state.maimemoConfig.token;
                if (notepadInput && !notepadInput.value) notepadInput.value = state.maimemoConfig.notepadId;
            }
        }

        function hideMaimemoForm(jobId) {
            const form = document.getElementById(`maimemoForm-${jobId}`);
            if (form) {
                form.classList.add('hidden');
                const notepadList = document.getElementById(`notepadList-${jobId}`);
                if (notepadList) notepadList.classList.add('hidden');
            }
        }

        async function loadNotepads(jobId) {
            const token = document.getElementById(`token-${jobId}`).value.trim();
            if (!token) {
                alert('è¯·å…ˆè¾“å…¥å¢¨å¢¨ API Token');
                return;
            }

            const notepadList = document.getElementById(`notepadList-${jobId}`);
            notepadList.innerHTML = '<div class="p-3 text-center"><span class="spinner"></span> æŸ¥è¯¢ä¸­...</div>';
            notepadList.classList.remove('hidden');

            try {
                const response = await fetch('/api/maimemo/list-notepads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const data = await response.json();

                if (response.ok && data.notepads && data.notepads.length > 0) {
                    notepadList.innerHTML = data.notepads.map(notepad => `
                        <div onclick="selectNotepad('${jobId}', '${notepad.id}', '${escapeHtml(notepad.title || 'æœªå‘½åè¯æœ¬')}')" class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="font-semibold text-gray-800">${escapeHtml(notepad.title || 'æœªå‘½åè¯æœ¬')}</div>
                            <div class="text-xs text-gray-500">${notepad.brief ? escapeHtml(notepad.brief) : 'ID: ' + notepad.id}</div>
                        </div>
                    `).join('');
                } else {
                    notepadList.innerHTML = `<div class="p-5 text-center text-gray-400"><p>ğŸ“­ æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºäº‘è¯æœ¬</p><p class="text-xs mt-1">è¯·åœ¨å¢¨å¢¨ APP ä¸­åˆ›å»ºäº‘è¯æœ¬</p></div>`;
                }
            } catch (error) {
                notepadList.innerHTML = `<div class="p-4 text-center text-red-800">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        function selectNotepad(jobId, notepadId, notepadName) {
            const input = document.getElementById(`notepadId-${jobId}`);
            if (input) input.value = notepadId;

            const notepadList = document.getElementById(`notepadList-${jobId}`);
            if (notepadList) notepadList.classList.add('hidden');

            console.log(`å·²é€‰æ‹©äº‘è¯æœ¬: ${notepadName} (ID: ${notepadId})`);
        }

        async function syncToMaimemo(jobId) {
            const token = document.getElementById(`token-${jobId}`).value.trim();
            const notepadId = document.getElementById(`notepadId-${jobId}`).value.trim();

            if (!token) {
                alert('è¯·è¾“å…¥å¢¨å¢¨ API Token');
                return;
            }
            if (!notepadId) {
                alert('è¯·è¾“å…¥äº‘è¯æœ¬ ID');
                return;
            }

            const job = state.jobs[jobId];
            if (!job || !job.vocabulary || job.vocabulary.length === 0) {
                alert('æ²¡æœ‰å¯åŒæ­¥çš„å•è¯');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å°† ${job.vocabulary.length} ä¸ªå•è¯åŒæ­¥åˆ°å¢¨å¢¨èƒŒå•è¯å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}/sync-to-maimemo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, notepad_id: notepadId })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ${data.message}\n\nå·²æˆåŠŸåŒæ­¥ ${data.count} ä¸ªå•è¯åˆ°å¢¨å¢¨èƒŒå•è¯ï¼`);
                    saveMaimemoConfig(token, notepadId);
                    hideMaimemoForm(jobId);
                } else {
                    alert(`âŒ åŒæ­¥å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();

                if (data.jobs && data.jobs.length > 0) {
                    data.jobs.forEach(job => {
                        state.jobs[job.job_id] = job;
                        state.expandedJobs[job.job_id] = false;
                    });
                    renderTasks();
                    startPolling();
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        });

        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>
